{% extends "base.html" %}
{% load static %}

{% block title %}Programme de Fid√©lit√©{% endblock %}

{% block content %}
<div class="container mt-4">
    <h1 class="mb-4">üíé Programme de Fid√©lit√©</h1>

    <!-- Loyalty Profile Card -->
    <div class="row mb-4">
        <div class="col-md-8">
            <div class="card text-white shadow-lg" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                <div class="card-body p-4">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <div>
                            <h3 class="mb-1 fw-bold text-white">{{ profile.points }} Points</h3>
                            <small class="d-block" style="color: #ffe066; font-weight: 500;">{{ profile.total_earned }} points gagn√©s au total</small>
                        </div>
                        <div class="text-end">
                            <span class="badge bg-warning text-dark fs-5 px-3 py-2 shadow-sm">
                                {% if profile.tier == 'bronze' %}ü•â Bronze
                                {% elif profile.tier == 'silver' %}ü•à Silver
                                {% elif profile.tier == 'gold' %}ü•á Gold
                                {% else %}üíé Platinum{% endif %}
                            </span>
                        </div>
                    </div>

                    {% if tier_info.next %}
                    <div class="mt-3 p-3 rounded" style="background: rgba(255,255,255,0.1);">
                        <small class="d-block mb-2 fw-bold" style="color: #ffe066;">Prochain niveau: {{ tier_info.next }}</small>
                        <div class="progress mb-2" style="height: 10px; background: rgba(255,255,255,0.2);">
                            <div class="progress-bar bg-warning" role="progressbar"
                                 style="width: {% widthratio profile.total_earned tier_info.needed|add:profile.total_earned 100 %}%"></div>
                        </div>
                        <small class="text-white fw-bold">Plus que {{ tier_info.needed }} points!</small>
                    </div>
                    {% else %}
                    <p class="mb-0 mt-3 p-2 rounded text-center fw-bold" style="background: rgba(255,255,255,0.1);"><small>üéâ Vous √™tes au niveau maximum!</small></p>
                    {% endif %}
                </div>
            </div>
        </div>

        <div class="col-md-4">
            <div class="card h-100">
                <div class="card-body text-center">
                    <h5 class="card-title">Comment √ßa marche?</h5>
                    <p class="small text-muted mb-2">
                        <strong>10 TND d√©pens√©s = 1 point</strong>
                    </p>
                    <hr>
                    <div class="text-start small">
                        <p class="mb-1">ü•â <strong>Bronze:</strong> 0 pts</p>
                        <p class="mb-1">ü•à <strong>Silver:</strong> 200 pts</p>
                        <p class="mb-1">ü•á <strong>Gold:</strong> 500 pts</p>
                        <p class="mb-0">üíé <strong>Platinum:</strong> 1000 pts</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Available Rewards -->
    <h3 class="mb-3">üéÅ R√©compenses Disponibles</h3>
    <div class="row mb-4">
        {% for reward in available_rewards %}
        <div class="col-md-4 mb-3">
            <div class="card h-100 {% if profile.points < reward.points_cost %}opacity-50{% endif %}">
                <div class="card-body">
                    <div class="text-center mb-2">
                        <span style="font-size: 3rem;">{{ reward.icon }}</span>
                    </div>
                    <h5 class="card-title text-center">{{ reward.name }}</h5>
                    <p class="card-text small text-muted">{{ reward.description }}</p>
                    <div class="text-center">
                        <span class="badge bg-primary mb-2">{{ reward.points_cost }} points</span>
                        {% if profile.points >= reward.points_cost %}
                        <form method="post" action="{% url 'redeem-reward' reward.id %}">
                            {% csrf_token %}
                            <button type="submit" class="btn btn-success btn-sm w-100">√âchanger</button>
                        </form>
                        {% else %}
                        <button class="btn btn-secondary btn-sm w-100" disabled>Points insuffisants</button>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
        {% empty %}
        <div class="col-12">
            <p class="text-muted text-center">Aucune r√©compense disponible pour le moment.</p>
        </div>
        {% endfor %}
    </div>

    <!-- My Redemptions -->
    {% if my_redemptions %}
    <h3 class="mb-3">üéüÔ∏è Mes R√©compenses</h3>
    <div class="card mb-4">
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-sm">
                    <thead>
                        <tr>
                            <th>R√©compense</th>
                            <th>Date</th>
                            <th>Points</th>
                            <th>Statut</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for redemption in my_redemptions %}
                        <tr>
                            <td>{{ redemption.reward.icon }} {{ redemption.reward.name }}</td>
                            <td>{{ redemption.redeemed_at|date:"d/m/Y" }}</td>
                            <td>{{ redemption.points_spent }} pts</td>
                            <td>
                                {% if redemption.used %}
                                <span class="badge bg-success">Utilis√©</span>
                                {% else %}
                                <span class="badge bg-warning text-dark">En attente</span>
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Recent Transactions -->
    <h3 class="mb-3">üìä Historique de Points</h3>
    <div class="card">
        <div class="card-body">
            {% if recent_transactions %}
            <div class="table-responsive">
                <table class="table table-sm">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Description</th>
                            <th class="text-end">Points</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for tx in recent_transactions %}
                        <tr>
                            <td>{{ tx.created_at|date:"d/m/Y H:i" }}</td>
                            <td>{{ tx.reason }}</td>
                            <td class="text-end">
                                <span class="{% if tx.amount > 0 %}text-success{% else %}text-danger{% endif %}">
                                    {% if tx.amount > 0 %}+{% endif %}{{ tx.amount }} pts
                                </span>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <p class="text-muted text-center mb-0">Aucune transaction pour le moment. Commencez √† gagner des points!</p>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}
